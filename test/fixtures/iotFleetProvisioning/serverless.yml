service: service

configValidationMode: error
frameworkVersion: '*'

provider:
  name: aws
  runtime: nodejs12.x
  versionFunctions: false

functions:
  registerDevice:
    handler: registerDevice.main
    environment:
      TEMPLATE_NAME:
        Ref: IotFleetProvisioningBasicIotProvisioningTemplate
  iotFleetProvisioningBasic:
    handler: hook.main
    events:
      - iotFleetProvisioning:
          templateBody: ${file(template.json)}
          provisioningRoleArn:
            'Fn::Sub': arn:aws:iam::${AWS::AccountId}:role/provisioning-role

resources:
  Resources:
    ProvisioningRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: provisioning-role
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSIoTThingsRegistration
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: iot.amazonaws.com
              Action: sts:AssumeRole
    IoTPolicy:
      Type: AWS::IoT::Policy
      Properties:
        PolicyName: iotPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action: 'iot:*'
              Resource: '*'
  Outputs:
    ProvisioningTemplateName:
      Value:
        Ref: IotFleetProvisioningBasicIotProvisioningTemplate
